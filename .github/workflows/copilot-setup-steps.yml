name: Copilot Setup Steps

# This workflow optimizes MCP server startup time for GitHub Copilot
# by pre-pulling and caching the Docker image on GitHub's runners.
#
# Key optimization:
# - Pre-pulls the MCPServer Docker image to avoid timeout during first use
#
# Note: The workflow verifies the MCP server can start and respond within
# acceptable timeframes. The main benefit is having the Docker image cached
# on GitHub's runners so it doesn't need to be pulled when Copilot starts.

on:
  workflow_dispatch:
  schedule:
    # Run daily to keep the cache fresh
    - cron: '0 0 * * *'
  push:
    branches:
      - main
      - 'release/**'
    paths:
      - 'Dockerfile'
      - 'Kernel/**'
      - 'PacletInfo.wl'
      - '.github/workflows/copilot-setup-steps.yml'

concurrency:
  group: copilot-setup-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  prepare-environment:
    name: Prepare MCP Server Environment
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine Docker image tag
        id: image-tag
        run: |
          # Use 'latest' tag which is built by the Docker.yml workflow
          TAG="latest"
          FULL_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "full_tag=${FULL_TAG}" >> $GITHUB_OUTPUT
          echo "Using Docker image: ${FULL_TAG}"

      - name: Pull Docker image
        run: |
          echo "Pulling Docker image: ${{ steps.image-tag.outputs.full_tag }}"
          docker pull "${{ steps.image-tag.outputs.full_tag }}"

      - name: Verify Docker image
        env:
          WOLFRAMSCRIPT_ENTITLEMENTID: ${{ secrets.WOLFRAMSCRIPT_ENTITLEMENTID }}
        run: |
          echo "Verifying Docker image functionality..."
          
          # Test that the container can start and respond
          docker run --rm \
            -e WOLFRAMSCRIPT_ENTITLEMENTID="${WOLFRAMSCRIPT_ENTITLEMENTID}" \
            "${{ steps.image-tag.outputs.full_tag }}" \
            wolframscript -code 'Print["Container is functional: ", $Version]' || {
              echo "Warning: Container verification completed with warnings."
              exit 0
            }

      - name: Test MCP server startup time
        env:
          WOLFRAMSCRIPT_ENTITLEMENTID: ${{ secrets.WOLFRAMSCRIPT_ENTITLEMENTID }}
        run: |
          echo "Testing MCP server startup time..."
          
          # Create a simple MCP client test that sends an initialize request
          cat > /tmp/test-mcp.sh << 'EOF'
          #!/bin/bash
          
          # Send an initialize request and check for a valid response
          # Capture the exit status immediately before any other commands
          RESULT=$(echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test-client","version":"1.0.0"}}}' | \
          timeout 30 docker run -i --rm \
            -e WOLFRAMSCRIPT_ENTITLEMENTID="${WOLFRAMSCRIPT_ENTITLEMENTID}" \
            -e MCP_SERVER_NAME=WolframLanguage \
            "$1" 2>/dev/null | head -n 1)
          
          if echo "$RESULT" | grep -q '"result"'; then
            echo "✓ MCP server responded successfully within timeout"
            exit 0
          else
            echo "✗ MCP server did not respond as expected"
            echo "Response: $RESULT"
            exit 1
          fi
          EOF
          
          chmod +x /tmp/test-mcp.sh
          
          # Measure startup time
          echo "Measuring startup time..."
          START_TIME=$(date +%s)
          /tmp/test-mcp.sh "${{ steps.image-tag.outputs.full_tag }}"
          END_TIME=$(date +%s)
          ELAPSED=$((END_TIME - START_TIME))
          echo "✓ Startup completed in ${ELAPSED} seconds"

      - name: Summary
        if: success()
        run: |
          echo "✓ MCP server environment prepared successfully"
          echo "✓ Docker image: ${{ steps.image-tag.outputs.full_tag }}"
          echo "✓ Docker image cached on runner"
          echo "✓ MCP server startup tested and verified"
          echo ""
          echo "GitHub Copilot should now start the MCP server faster by using the cached Docker image."
